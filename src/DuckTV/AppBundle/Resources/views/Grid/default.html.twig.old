{% extends 'DuckTVAppBundle::layout.html.twig' %}

{% block title %}{{ parent() }} - Grille{% endblock %}

{% block body %}
    <h1>Grille par défaut</h1>

    <table border="1" style="opacity:0">
                <tr>
                    <th></th>
                    <th>8h - 9h30</th>
                    <th>9h30 - 11h</th>
                    <th>11h - 12h30</th>
                    <th>12h30 - 14h</th>
                    <th>14h - 15h30</th>
                    <th>15h30 - 17h</th>
                    <th>17h - 18h30</th>
                </tr>
            {% for jour in jours %}
                <tr>
                    <th>{{ jour.day }} ({{ jour.date|date }})</th>
                    {% for slot in jour.slots %}

                        <td>
                            {% if slot.broadcasts is not empty %}
                                <ul class="sortable">
                                    {% for broadcast in slot.broadcasts %}
                                        <li>
                                            <input type="text" name="position" class="positionInput" value="{{ broadcast.position }}" />
                                            [{{ broadcast.position }}] {{ broadcast.video.title }} - {{ broadcast.video.duration }}s<br/>

                                            {{ form_start(delete_form) }}
                                                <input type="hidden" value="{{ broadcast.id }}" name="id" />
                                                <input type="submit" value="Supprimer">
                                            {{ form_end(delete_form) }}

                                            <form action="{{ path('duck_tv_app_grid_edit_cast') }}" method="post">
                                                <input type="url" name="url" placeholder="url vidéo" value="{{ broadcast.video.videoUrl }}" required />
                                                <input type="hidden" value="{{ broadcast.id }}" name="id" />
                                                <input type="submit" value="Éditer">
                                            </form>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}

                            <form action="{{ path('duck_tv_app_grid_new_cast') }}" method="post" id="form-{{ slot.id }}">
                                <input type="url" name="url" placeholder="url vidéo" required />
                                <select name="category">
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" name="id" value="{{ slot.id }}" />
                            </form>

                            <a href="#" id="{{ slot.id }}">Ajouter</a>

                            <script>
                                $("#{{ slot.id }}").click(function(e) {
                                    e.preventDefault();
                                    var form = "form-{{ slot.id }}";
                                    $("#"+form).submit();
                                });
                            </script>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}

    </table>
    <script>
        // fonction pour inverser les lignes et les colonnes d'un tableau
        $("table").each(function () {
            var $this = $(this);
            var newrows = [];
            $this.find("tr").each(function () {
                var i = 0;
                $(this).find("td,th").each(function () {
                    i++;
                    if (newrows[i] === undefined) {
                        newrows[i] = $("<tr></tr>");
                    }
                    newrows[i].append($(this));
                });
            });
            $this.find("tr").remove();
            $.each(newrows, function () {
                $this.append(this);
            });
        });

        // on joue sur l'opacité au chargement pour éviter l'effet de saut d'inversion des tr td
        $("table").css({opacity : 1});
    </script>

    <script>
        $(document).ready(function(){
            $( ".sortable" ).sortable({
                update : function(e, ui) {
                    var list = ui.item.parent("ul");
                    var pos = 0;
                    $(list.find("li")).each(function(){
                        pos++;
                        $(this).find("input.positionInput").val(pos);
                    });
                }
            });
            $( ".sortable" ).disableSelection();
        });
    </script>

{% endblock %}
